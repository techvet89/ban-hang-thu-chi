<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm Qu·∫£n l√Ω B√°n h√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .sidebar-icon { width: 24px; text-align: center; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body * { visibility: hidden; }
            #invoice-print-area, #invoice-print-area * { visibility: visible; }
            #invoice-print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col justify-center items-center">
        <div class="loader"></div>
        <p class="mt-4 text-slate-600">ƒêang k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß...</p>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex-col min-h-screen hidden md:flex">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω</h1>
            </div>
            <nav id="sidebar-nav" class="flex-1 p-2">
                <ul>
                    <li><a href="#dashboard" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors bg-blue-50 text-blue-600"><span class="sidebar-icon">üìä</span>B·∫£ng ƒëi·ªÅu khi·ªÉn</a></li>
                    <li><a href="#orders" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100"><span class="sidebar-icon">üõí</span>ƒê∆°n h√†ng</a></li>
                    <li><a href="#products" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100"><span class="sidebar-icon">üì¶</span>S·∫£n ph·∫©m</a></li>
                    <li><a href="#customers" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100"><span class="sidebar-icon">üë•</span>Kh√°ch h√†ng</a></li>
                    <li><a href="#finance" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100"><span class="sidebar-icon">üí∞</span>T√†i ch√≠nh</a></li>
                    <li><a href="#reports" class="nav-link flex items-center gap-3 px-4 py-3 my-1 rounded-lg text-left text-sm font-medium transition-colors text-gray-600 hover:bg-gray-100"><span class="sidebar-icon">üìÑ</span>B√°o c√°o</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div id="dashboard" class="page"></div>
            <div id="orders" class="page hidden"></div>
            <div id="products" class="page hidden"></div>
            <div id="customers" class="page hidden"></div>
            <div id="finance" class="page hidden"></div>
            <div id="reports" class="page hidden"></div>
        </main>
    </div>

    <!-- Modal Template -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden"></div>
    
    <!-- Toast Notification Template -->
    <div id="toast-template" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRwR7otaGcytYR09kOQPwPL6DUW4iTRGA",
            authDomain: "quan-ly-ban-hang-cua-toi.firebaseapp.com",
            projectId: "quan-ly-ban-hang-cua-toi",
            storageBucket: "quan-ly-ban-hang-cua-toi.firebasestorage.app",
            messagingSenderId: "561156340453",
            appId: "1:561156340453:web:24a43f1a1af87cae02f20c",
            measurementId: "G-1NJZYY05QH"
        };
        const appId = firebaseConfig.projectId;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            products: [], customers: [], orders: [], incomes: [], expenses: [],
            finances: { cash: 0, bankAccount: 0 },
            userId: null, authReady: false,
        };
        let reportChart = null;
        let unsubscribeListeners = [];

        const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value || 0);
        const formatDate = (isoString) => isoString ? new Date(isoString).toLocaleDateString('vi-VN') : 'N/A';
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-template');
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        const modalContainer = document.getElementById('modal-container');
        function openModal(title, contentHTML, size = 'max-w-2xl') {
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full ${size}">
                        <h3 class="text-xl font-bold mb-4">${title}</h3>
                        ${contentHTML}
                    </div>
                </div>`;
            modalContainer.classList.remove('hidden');
        }
        function closeModal() { modalContainer.classList.add('hidden'); modalContainer.innerHTML = ''; }
        window.closeModal = closeModal;

        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        function showPage(pageId) {
            pages.forEach(page => page.classList.toggle('hidden', page.id !== pageId));
            navLinks.forEach(link => {
                link.classList.toggle('bg-blue-50', link.hash === `#${pageId}`);
                link.classList.toggle('text-blue-600', link.hash === `#${pageId}`);
                link.classList.toggle('text-gray-600', link.hash !== `#${pageId}`);
                link.classList.toggle('hover:bg-gray-100', link.hash !== `#${pageId}`);
            });
            const renderFunction = window[`render${capitalize(pageId)}Page`];
            if (typeof renderFunction === 'function') renderFunction();
        }
        const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);
        document.getElementById('sidebar-nav').addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                showPage(link.hash.substring(1));
            }
        });

        // --- RENDER FUNCTIONS ---
        window.renderDashboardPage = function() {
            const totalStockValue = state.products.reduce((sum, p) => sum + (p.importPrice * p.stock), 0);
            const totalDebt = state.customers.reduce((sum, c) => sum + (c.debt || 0), 0);
            document.getElementById('dashboard').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><h3 class="text-gray-500">Ti·ªÅn m·∫∑t</h3><p class="text-2xl font-bold">${formatCurrency(state.finances.cash)}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><h3 class="text-gray-500">T√†i kho·∫£n</h3><p class="text-2xl font-bold">${formatCurrency(state.finances.bankAccount)}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><h3 class="text-gray-500">Gi√° tr·ªã kho</h3><p class="text-2xl font-bold">${formatCurrency(totalStockValue)}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border"><h3 class="text-gray-500">C√¥ng n·ª£</h3><p class="text-2xl font-bold text-red-600">${formatCurrency(totalDebt)}</p></div>
                </div>`;
        }
        
        window.renderProductsPage = function() {
            document.getElementById('products').innerHTML = `
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">S·∫£n ph·∫©m</h2><button id="add-product-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Th√™m s·∫£n ph·∫©m</button></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><table class="w-full">
                    <thead><tr class="border-b-2"><th class="p-3 text-left">T√™n</th><th class="p-3 text-left">Gi√° nh·∫≠p</th><th class="p-3 text-left">Gi√° b√°n</th><th class="p-3 text-left">T·ªìn kho</th></tr></thead>
                    <tbody>${state.products.map(p => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">${p.name}</td><td>${formatCurrency(p.importPrice)}</td><td>${formatCurrency(p.sellingPrice)}</td><td>${p.stock}</td>
                        </tr>`).join('')}
                    </tbody>
                </table></div>`;
            document.getElementById('add-product-btn').addEventListener('click', () => showProductForm());
        }

        window.renderOrdersPage = function() {
            document.getElementById('orders').innerHTML = `
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">ƒê∆°n h√†ng</h2><button id="add-order-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Th√™m ƒë∆°n h√†ng</button></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><table class="w-full">
                    <thead><tr class="border-b-2"><th class="p-3 text-left">M√£ ƒêH</th><th class="p-3 text-left">Kh√°ch h√†ng</th><th class="p-3 text-left">T·ªïng ti·ªÅn</th><th class="p-3 text-left">Thanh to√°n</th><th class="p-3 text-left">Ng√†y</th><th class="p-3 text-left"></th></tr></thead>
                    <tbody>${state.orders.map(o => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">#${o.id.substring(0,5)}</td><td>${o.customerName}</td><td>${formatCurrency(o.totalAmount)}</td><td>${o.paymentMethod}</td><td>${formatDate(o.createdAt)}</td>
                            <td><button class="print-invoice-btn text-blue-600" data-order-id='${o.id}'>In Hƒê</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table></div>`;
            document.getElementById('add-order-btn').addEventListener('click', showOrderForm);
            document.querySelectorAll('.print-invoice-btn').forEach(btn => btn.addEventListener('click', (e) => showInvoice(e.target.dataset.orderId)));
        }

        window.renderCustomersPage = function() {
            document.getElementById('customers').innerHTML = `
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">Kh√°ch h√†ng</h2></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border"><table class="w-full">
                    <thead><tr class="border-b-2"><th class="p-3 text-left">T√™n</th><th class="p-3 text-left">ƒêi·ªán tho·∫°i</th><th class="p-3 text-left">C√¥ng n·ª£</th><th class="p-3 text-left"></th></tr></thead>
                    <tbody>${state.customers.map(c => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3">${c.name}</td><td>${c.phone}</td><td class="text-red-600 font-semibold">${formatCurrency(c.debt)}</td>
                            <td><button class="view-customer-btn text-blue-600" data-customer-id='${c.id}'>Xem chi ti·∫øt</button></td>
                        </tr>`).join('')}
                    </tbody>
                </table></div>`;
            document.querySelectorAll('.view-customer-btn').forEach(btn => btn.addEventListener('click', (e) => showCustomerDetail(e.target.dataset.customerId)));
        }

        window.renderFinancePage = function() {
             const totalIncome = state.incomes.reduce((sum, item) => sum + item.amount, 0);
             const totalExpense = state.expenses.reduce((sum, item) => sum + item.amount, 0);
             document.getElementById('finance').innerHTML = `
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">T√†i ch√≠nh</h2></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="text-xl font-semibold text-green-600 mb-4">Thu (L·ª£i nhu·∫≠n)</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">${state.incomes.map(item => `<div class="flex justify-between p-2 bg-green-50 rounded-lg"><span>${item.description}</span><span class="font-semibold">${formatCurrency(item.amount)}</span></div>`).join('')}</div>
                        <div class="mt-4 pt-4 border-t font-bold text-lg flex justify-between"><span>T·ªïng thu:</span><span>${formatCurrency(totalIncome)}</span></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="text-xl font-semibold text-red-600 mb-4">Chi</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">${state.expenses.map(item => `<div class="flex justify-between p-2 bg-red-50 rounded-lg"><span>${item.description}</span><span class="font-semibold">${formatCurrency(item.amount)}</span></div>`).join('')}</div>
                        <div class="mt-4 pt-4 border-t font-bold text-lg flex justify-between"><span>T·ªïng chi:</span><span>${formatCurrency(totalExpense)}</span></div>
                    </div>
                </div>`;
        }
        
        window.renderReportsPage = () => { /* Logic t∆∞∆°ng t·ª± c√°c trang kh√°c */ document.getElementById('reports').innerHTML = `<h2 class="text-3xl font-bold text-gray-800">B√°o c√°o</h2><p>ƒêang x√¢y d·ª±ng...</p>`;}

        // --- FORM & ACTION FUNCTIONS ---
        function showProductForm() { /* Logic t∆∞∆°ng t·ª± phi√™n b·∫£n tr∆∞·ªõc */ }
        
        function showOrderForm() {
            let itemsHTML = `<div id="order-items">
                <div class="flex items-center gap-2 mb-2">
                    <select name="productId" class="order-item-product block w-full p-2 border rounded-md">${state.products.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select>
                    <input type="number" name="quantity" value="1" min="1" class="order-item-quantity w-20 p-2 border rounded-md" />
                </div>
            </div>`;
            const formContent = `
                <form id="order-form" class="space-y-4">
                    <label class="block text-sm font-medium">S·∫£n ph·∫©m</label>
                    ${itemsHTML}
                    <button type="button" id="add-order-item-btn" class="text-sm text-blue-600">+ Th√™m s·∫£n ph·∫©m</button>
                    <div><label class="block text-sm font-medium">Kh√°ch h√†ng</label><select name="customerId" class="mt-1 block w-full p-2 border rounded-md"><option value="">Kh√°ch l·∫ª</option>${state.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium">Thanh to√°n</label><select name="paymentMethod" class="mt-1 block w-full p-2 border rounded-md"><option>Ti·ªÅn m·∫∑t</option><option>Chuy·ªÉn kho·∫£n</option><option>C√¥ng n·ª£</option></select></div>
                    <div class="text-right font-bold text-lg" id="order-total">T·ªïng c·ªông: 0 ‚Ç´</div>
                    <div class="mt-6 flex justify-end gap-3"><button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg">H·ªßy</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">T·∫°o ƒë∆°n</button></div>
                </form>`;
            openModal('T·∫°o ƒë∆°n h√†ng m·ªõi', formContent);
            
            const orderItemsContainer = document.getElementById('order-items');
            document.getElementById('add-order-item-btn').addEventListener('click', () => {
                const newItem = orderItemsContainer.children[0].cloneNode(true);
                newItem.querySelector('input').value = 1;
                orderItemsContainer.appendChild(newItem);
            });
            
            document.getElementById('order-form').addEventListener('change', updateTotal);
            document.getElementById('order-form').addEventListener('submit', saveOrder);
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll('#order-items > div').forEach(itemDiv => {
                const productId = itemDiv.querySelector('.order-item-product').value;
                const quantity = parseInt(itemDiv.querySelector('.order-item-quantity').value) || 0;
                const product = state.products.find(p => p.id === productId);
                if (product) {
                    total += product.sellingPrice * quantity;
                }
            });
            document.getElementById('order-total').textContent = `T·ªïng c·ªông: ${formatCurrency(total)}`;
        }

        async function saveOrder(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const customerId = formData.get('customerId');
            const customer = state.customers.find(c => c.id === customerId);
            const paymentMethod = formData.get('paymentMethod');
            
            const items = [];
            document.querySelectorAll('#order-items > div').forEach(itemDiv => {
                const productId = itemDiv.querySelector('select[name="productId"]').value;
                const quantity = parseInt(itemDiv.querySelector('input[name="quantity"]').value) || 0;
                const product = state.products.find(p => p.id === productId);
                if (product && quantity > 0) {
                    items.push({
                        productId,
                        productName: product.name,
                        quantity,
                        importPrice: product.importPrice,
                        sellingPrice: product.sellingPrice,
                    });
                }
            });

            if (items.length === 0) {
                showToast('Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o ƒë∆°n h√†ng.', 'error');
                return;
            }

            const totalAmount = items.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
            const totalProfit = items.reduce((sum, item) => sum + ((item.sellingPrice - item.importPrice) * item.quantity), 0);

            const orderData = {
                items, totalAmount, paymentMethod,
                customerId: customerId || null,
                customerName: customer ? customer.name : 'Kh√°ch l·∫ª',
                profit: totalProfit,
                createdAt: new Date().toISOString(),
            };
            
            // Firestore transaction
            try {
                const financeRef = doc(db, `artifacts/${appId}/users/${state.userId}/finances/summary`);
                await runTransaction(db, async (transaction) => {
                    // 1. Get current finance state
                    const financeDoc = await transaction.get(financeRef);
                    if (!financeDoc.exists()) throw "Finance document does not exist!";
                    const currentFinance = financeDoc.data();

                    // 2. Add order
                    const orderRef = doc(collection(db, `artifacts/${appId}/users/${state.userId}/orders`));
                    transaction.set(orderRef, orderData);

                    // 3. Update finances & customer debt
                    if (paymentMethod === 'Ti·ªÅn m·∫∑t') {
                        transaction.update(financeRef, { cash: currentFinance.cash + totalAmount });
                    } else if (paymentMethod === 'Chuy·ªÉn kho·∫£n') {
                        transaction.update(financeRef, { bankAccount: currentFinance.bankAccount + totalAmount });
                    } else if (paymentMethod === 'C√¥ng n·ª£' && customerId) {
                        const customerRef = doc(db, `artifacts/${appId}/users/${state.userId}/customers`, customerId);
                        transaction.update(customerRef, { debt: (customer.debt || 0) + totalAmount });
                    }
                    
                    // 4. Add income transaction
                    const incomeRef = doc(collection(db, `artifacts/${appId}/users/${state.userId}/incomes`));
                    transaction.set(incomeRef, { description: `L·ª£i nhu·∫≠n t·ª´ ƒêH #${orderRef.id.substring(0,5)}`, amount: totalProfit, date: new Date().toISOString() });

                    // 5. Update stock
                    for (const item of items) {
                        const productRef = doc(db, `artifacts/${appId}/users/${state.userId}/products`, item.productId);
                        const productDoc = state.products.find(p => p.id === item.productId);
                        transaction.update(productRef, { stock: productDoc.stock - item.quantity });
                    }
                });
                showToast('T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!');
                closeModal();
            } catch (error) {
                console.error("Order transaction failed:", error);
                showToast('T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i.', 'error');
            }
        }
        
        function showInvoice(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) return;
            const content = `
                <div id="invoice-print-area">
                    <h2 class="text-2xl font-bold text-center mb-6">H√ìA ƒê∆†N B√ÅN H√ÄNG</h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div><p><strong>Kh√°ch h√†ng:</strong> ${order.customerName}</p><p><strong>Ng√†y:</strong> ${formatDate(order.createdAt)}</p></div>
                        <div class="text-right"><p><strong>M√£ Hƒê:</strong> #${order.id.substring(0,7).toUpperCase()}</p><p><strong>Thanh to√°n:</strong> ${order.paymentMethod}</p></div>
                    </div>
                    <table class="w-full mb-6">
                        <thead class="bg-gray-100"><tr><th class="p-2 text-left">S·∫£n ph·∫©m</th><th class="p-2 text-right">SL</th><th class="p-2 text-right">ƒê∆°n gi√°</th><th class="p-2 text-right">Th√†nh ti·ªÅn</th></tr></thead>
                        <tbody>${order.items.map(item => `<tr class="border-b"><td class="p-2">${item.productName}</td><td class="p-2 text-right">${item.quantity}</td><td class="p-2 text-right">${formatCurrency(item.sellingPrice)}</td><td class="p-2 text-right">${formatCurrency(item.sellingPrice * item.quantity)}</td></tr>`).join('')}</tbody>
                    </table>
                    <div class="text-right"><p class="text-lg font-bold">T·ªïng c·ªông: ${formatCurrency(order.totalAmount)}</p></div>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end gap-3 mt-4">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded-lg">ƒê√≥ng</button>
                    <button id="print-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg">In h√≥a ƒë∆°n</button>
                </div>`;
            openModal('H√≥a ƒë∆°n b√°n h√†ng', content);
            document.getElementById('print-btn').addEventListener('click', () => window.print());
        }
        
        async function showCustomerDetail(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (!customer) return;
            const q = query(collection(db, `artifacts/${appId}/users/${state.userId}/orders`), where("customerId", "==", customerId));
            const ordersSnap = await getDocs(q);
            const customerOrders = ordersSnap.docs.map(d => d.data());
            
            const content = `
                <div class="mb-4"><p><strong>ƒêi·ªán tho·∫°i:</strong> ${customer.phone}</p><p><strong>T·ªïng c√¥ng n·ª£:</strong> <span class="font-bold text-red-600">${formatCurrency(customer.debt)}</span></p></div>
                <h4 class="text-lg font-semibold mb-2">L·ªãch s·ª≠ ƒë∆°n h√†ng</h4>
                <div class="max-h-80 overflow-y-auto border rounded-lg">
                    <table class="w-full">
                        <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2 text-left">Ng√†y</th><th class="p-2 text-right">T·ªïng ti·ªÅn</th></tr></thead>
                        <tbody>${customerOrders.map(o => `<tr class="border-b"><td class="p-2">${formatDate(o.createdAt)}</td><td class="p-2 text-right">${formatCurrency(o.totalAmount)}</td></tr>`).join('')}</tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end"><button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg">ƒê√≥ng</button></div>`;
            openModal(`Chi ti·∫øt: ${customer.name}`, content, 'max-w-3xl');
        }

        // --- AUTH & DATA INITIALIZATION ---
        onAuthStateChanged(auth, user => {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (user) {
                state.userId = user.uid;
                state.authReady = true;
                
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];

                const collectionsToWatch = ['products', 'customers', 'orders', 'incomes', 'expenses'];
                collectionsToWatch.forEach(collName => {
                    const q = query(collection(db, `artifacts/${appId}/users/${state.userId}/${collName}`));
                    const unsub = onSnapshot(q, (snapshot) => {
                        state[collName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const currentPage = document.querySelector('.nav-link.bg-blue-50')?.hash.substring(1) || 'dashboard';
                        showPage(currentPage);
                    });
                    unsubscribeListeners.push(unsub);
                });
                
                const financeUnsub = onSnapshot(doc(db, `artifacts/${appId}/users/${state.userId}/finances`, 'summary'), (doc) => {
                    if (doc.exists()) state.finances = doc.data();
                    const currentPage = document.querySelector('.nav-link.bg-blue-50')?.hash.substring(1) || 'dashboard';
                    showPage(currentPage);
                });
                unsubscribeListeners.push(financeUnsub);

                loadingOverlay.classList.add('hidden');
                showPage('dashboard');
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    loadingOverlay.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase v√† ƒë·∫£m b·∫£o ƒë√£ b·∫≠t ƒêƒÉng nh·∫≠p ·∫©n danh.</p>';
                });
            }
        });
    </script>
</body>
</html>
